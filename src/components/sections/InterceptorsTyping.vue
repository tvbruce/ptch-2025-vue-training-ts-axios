<template>
    <div class="interceptors-typing">
        <div class="section-intro">
            <h2>æ””æˆªå™¨å‹åˆ¥å®šç¾©</h2>
            <p class="intro-text">
                Axios æ””æˆªå™¨æ˜¯å¯¦ç¾çµ±ä¸€è«‹æ±‚è™•ç†ã€éŸ¿æ‡‰è™•ç†å’ŒéŒ¯èª¤è™•ç†çš„å¼·å¤§å·¥å…·ã€‚
                æœ¬ç« ç¯€å°‡æ·±å…¥æ¢è¨å¦‚ä½•åœ¨ TypeScript ä¸­æ­£ç¢ºå®šç¾©å’Œä½¿ç”¨æ””æˆªå™¨å‹åˆ¥ã€‚
            </p>
        </div>

        <div class="interceptor-concepts">
            <h3>æ””æˆªå™¨æ¦‚å¿µ</h3>
            <div class="concepts-grid">
                <div class="concept-card">
                    <h4>è«‹æ±‚æ””æˆªå™¨</h4>
                    <p>åœ¨è«‹æ±‚ç™¼é€å‰åŸ·è¡Œï¼Œå¯ä»¥ä¿®æ”¹è«‹æ±‚é…ç½®ã€æ·»åŠ èªè­‰ tokenã€è¨­å®šå…¬å…± headers ç­‰ã€‚</p>
                </div>
                <div class="concept-card">
                    <h4>éŸ¿æ‡‰æ””æˆªå™¨</h4>
                    <p>åœ¨éŸ¿æ‡‰è¿”å›å¾ŒåŸ·è¡Œï¼Œå¯ä»¥çµ±ä¸€è™•ç†éŸ¿æ‡‰æ•¸æ“šã€éŒ¯èª¤è™•ç†ã€token åˆ·æ–°ç­‰ã€‚</p>
                </div>
            </div>
        </div>

        <div class="request-interceptors">
            <h3>è«‹æ±‚æ””æˆªå™¨å‹åˆ¥</h3>
            <CodeBlock title="è«‹æ±‚æ””æˆªå™¨å‹åˆ¥å®šç¾©" :code="requestInterceptorTypes" language="typescript"
                explanation="å®šç¾©è«‹æ±‚æ””æˆªå™¨çš„å‹åˆ¥ï¼ŒåŒ…å«é…ç½®ä¿®æ”¹å’ŒéŒ¯èª¤è™•ç†" />
        </div>

        <div class="response-interceptors">
            <h3>éŸ¿æ‡‰æ””æˆªå™¨å‹åˆ¥</h3>
            <CodeBlock title="éŸ¿æ‡‰æ””æˆªå™¨å‹åˆ¥å®šç¾©" :code="responseInterceptorTypes" language="typescript"
                explanation="å®šç¾©éŸ¿æ‡‰æ””æˆªå™¨çš„å‹åˆ¥ï¼Œè™•ç†æˆåŠŸéŸ¿æ‡‰å’ŒéŒ¯èª¤éŸ¿æ‡‰" />
        </div>

        <div class="practical-examples">
            <h3>å¯¦æˆ°ç¯„ä¾‹</h3>
            <div class="example-tabs">
                <button v-for="example in examples" :key="example.id" class="tab-button"
                    :class="{ active: activeExample === example.id }" @click="activeExample = example.id">
                    {{ example.title }}
                </button>
            </div>

            <div class="example-content">
                <div v-for="example in examples" :key="example.id" v-show="activeExample === example.id">
                    <CodeBlock :title="example.title" :code="example.code" language="typescript"
                        :explanation="example.explanation" :runnable="true" @run="runExample" />
                </div>
            </div>
        </div>

        <div class="advanced-patterns">
            <h3>é€²éšæ¨¡å¼</h3>
            <div class="pattern-grid">
                <div class="pattern-card">
                    <h4>æ””æˆªå™¨éˆ</h4>
                    <CodeBlock title="å¤šå€‹æ””æˆªå™¨çµ„åˆ" :code="interceptorChainCode" language="typescript"
                        explanation="å±•ç¤ºå¦‚ä½•çµ„åˆå¤šå€‹æ””æˆªå™¨å½¢æˆè™•ç†éˆ" />
                </div>

                <div class="pattern-card">
                    <h4>æ¢ä»¶æ””æˆªå™¨</h4>
                    <CodeBlock title="åŸºæ–¼æ¢ä»¶çš„æ””æˆªå™¨" :code="conditionalInterceptorCode" language="typescript"
                        explanation="æ ¹æ“šä¸åŒæ¢ä»¶æ‡‰ç”¨ä¸åŒçš„æ””æˆªå™¨é‚è¼¯" />
                </div>
            </div>
        </div>

        <div class="best-practices">
            <h3>æœ€ä½³å¯¦è¸</h3>
            <div class="practice-list">
                <div class="practice-item">
                    <h4>ğŸ”’ å®‰å…¨æ€§è€ƒæ…®</h4>
                    <ul>
                        <li>é¿å…åœ¨æ””æˆªå™¨ä¸­æ´©éœ²æ•æ„Ÿä¿¡æ¯</li>
                        <li>å®‰å…¨åœ°è™•ç†èªè­‰ token</li>
                        <li>é˜²æ­¢ç„¡é™é‡è©¦å¾ªç’°</li>
                    </ul>
                </div>

                <div class="practice-item">
                    <h4>âš¡ æ€§èƒ½å„ªåŒ–</h4>
                    <ul>
                        <li>é¿å…åœ¨æ””æˆªå™¨ä¸­åŸ·è¡Œé‡è¨ˆç®—</li>
                        <li>ä½¿ç”¨å¿«å–æ¸›å°‘é‡è¤‡è™•ç†</li>
                        <li>åˆç†è¨­å®šè¶…æ™‚å’Œé‡è©¦æ¬¡æ•¸</li>
                    </ul>
                </div>

                <div class="practice-item">
                    <h4>ğŸ› éŒ¯èª¤è™•ç†</h4>
                    <ul>
                        <li>æä¾›æœ‰æ„ç¾©çš„éŒ¯èª¤è¨Šæ¯</li>
                        <li>è¨˜éŒ„è©³ç´°çš„éŒ¯èª¤æ—¥èªŒ</li>
                        <li>å¯¦ç¾å„ªé›…çš„é™ç´šç­–ç•¥</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="navigation-footer">
            <button class="btn-complete" @click="completeSection">
                å®Œæˆæœ¬ç« ç¯€
            </button>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import CodeBlock from '@/components/common/CodeBlock.vue'

const emit = defineEmits<{
    complete: []
}>()

const activeExample = ref('auth-interceptor')

const requestInterceptorTypes = `// è«‹æ±‚æ””æˆªå™¨å‹åˆ¥å®šç¾©
import type { AxiosRequestConfig, InternalAxiosRequestConfig } from 'axios'

// è‡ªå®šç¾©è«‹æ±‚é…ç½®å‹åˆ¥
interface CustomAxiosRequestConfig extends AxiosRequestConfig {
  skipAuth?: boolean
  retryCount?: number
  skipErrorHandler?: boolean
}

// è«‹æ±‚æ””æˆªå™¨å›èª¿å‹åˆ¥
type RequestInterceptorFulfilled = (
  config: InternalAxiosRequestConfig
) => InternalAxiosRequestConfig | Promise<InternalAxiosRequestConfig>

type RequestInterceptorRejected = (error: any) => any

// æ””æˆªå™¨é¸é …å‹åˆ¥
interface InterceptorOptions {
  synchronous?: boolean
  runWhen?: (config: InternalAxiosRequestConfig) => boolean
}

// è«‹æ±‚æ””æˆªå™¨é…ç½®
interface RequestInterceptorConfig {
  fulfilled: RequestInterceptorFulfilled
  rejected?: RequestInterceptorRejected
  options?: InterceptorOptions
}`

const responseInterceptorTypes = `// éŸ¿æ‡‰æ””æˆªå™¨å‹åˆ¥å®šç¾©
import type { AxiosResponse, AxiosError } from 'axios'

// éŸ¿æ‡‰æ””æˆªå™¨å›èª¿å‹åˆ¥
type ResponseInterceptorFulfilled<T = any> = (
  response: AxiosResponse<T>
) => AxiosResponse<T> | Promise<AxiosResponse<T>>

type ResponseInterceptorRejected = (error: AxiosError) => any

// éŸ¿æ‡‰æ””æˆªå™¨é…ç½®
interface ResponseInterceptorConfig<T = any> {
  fulfilled: ResponseInterceptorFulfilled<T>
  rejected?: ResponseInterceptorRejected
  options?: InterceptorOptions
}

// éŒ¯èª¤é¡å‹å®šç¾©
interface ApiError {
  code: string
  message: string
  status?: number
  data?: any
}

// çµ±ä¸€éŒ¯èª¤è™•ç†å‹åˆ¥
type ErrorHandler = (error: AxiosError) => Promise<any> | any`

const examples = [
    {
        id: 'auth-interceptor',
        title: 'èªè­‰æ””æˆªå™¨',
        code: `// èªè­‰æ””æˆªå™¨å¯¦ç¾
import axios, { type InternalAxiosRequestConfig, type AxiosResponse } from 'axios'

interface AuthConfig {
  getToken: () => string | null
  refreshToken: () => Promise<string>
  onAuthError: () => void
}

class AuthInterceptor {
  private authConfig: AuthConfig

  constructor(authConfig: AuthConfig) {
    this.authConfig = authConfig
  }

  // è«‹æ±‚æ””æˆªå™¨ - è‡ªå‹•æ·»åŠ èªè­‰ token
  setupRequestInterceptor(axiosInstance: typeof axios) {
    axiosInstance.interceptors.request.use(
      (config: InternalAxiosRequestConfig) => {
        // è·³éèªè­‰çš„è«‹æ±‚
        if (config.skipAuth) {
          return config
        }

        const token = this.authConfig.getToken()
        if (token && config.headers) {
          config.headers.Authorization = \`Bearer \${token}\`
        }

        return config
      },
      (error) => {
        return Promise.reject(error)
      }
    )
  }

  // éŸ¿æ‡‰æ””æˆªå™¨ - è™•ç†èªè­‰éŒ¯èª¤å’Œ token åˆ·æ–°
  setupResponseInterceptor(axiosInstance: typeof axios) {
    axiosInstance.interceptors.response.use(
      (response: AxiosResponse) => response,
      async (error) => {
        const originalRequest = error.config

        // è™•ç† 401 éŒ¯èª¤ - token éæœŸ
        if (error.response?.status === 401 && !originalRequest._retry) {
          originalRequest._retry = true

          try {
            const newToken = await this.authConfig.refreshToken()
            if (newToken && originalRequest.headers) {
              originalRequest.headers.Authorization = \`Bearer \${newToken}\`
            }
            return axiosInstance(originalRequest)
          } catch (refreshError) {
            this.authConfig.onAuthError()
            return Promise.reject(refreshError)
          }
        }

        return Promise.reject(error)
      }
    )
  }
}`,
        explanation: 'å±•ç¤ºå¦‚ä½•å¯¦ç¾å®Œæ•´çš„èªè­‰æ””æˆªå™¨ï¼ŒåŒ…å« token æ·»åŠ å’Œè‡ªå‹•åˆ·æ–°'
    },
    {
        id: 'logging-interceptor',
        title: 'æ—¥èªŒæ””æˆªå™¨',
        code: `// æ—¥èªŒæ””æˆªå™¨å¯¦ç¾
interface LogConfig {
  logRequests: boolean
  logResponses: boolean
  logErrors: boolean
  sensitiveHeaders: string[]
}

class LoggingInterceptor {
  private config: LogConfig

  constructor(config: LogConfig) {
    this.config = config
  }

  setup(axiosInstance: typeof axios) {
    // è«‹æ±‚æ—¥èªŒæ””æˆªå™¨
    if (this.config.logRequests) {
      axiosInstance.interceptors.request.use(
        (config: InternalAxiosRequestConfig) => {
          const logData = {
            method: config.method?.toUpperCase(),
            url: config.url,
            headers: this.filterSensitiveHeaders(config.headers),
            timestamp: new Date().toISOString()
          }

          console.log('ğŸ”„ API Request:', logData)
          return config
        }
      )
    }

    // éŸ¿æ‡‰æ—¥èªŒæ””æˆªå™¨
    if (this.config.logResponses) {
      axiosInstance.interceptors.response.use(
        (response: AxiosResponse) => {
          const logData = {
            status: response.status,
            url: response.config.url,
            duration: this.calculateDuration(response.config),
            timestamp: new Date().toISOString()
          }

          console.log('âœ… API Response:', logData)
          return response
        },
        (error) => {
          if (this.config.logErrors) {
            const logData = {
              status: error.response?.status,
              url: error.config?.url,
              message: error.message,
              timestamp: new Date().toISOString()
            }

            console.error('âŒ API Error:', logData)
          }
          return Promise.reject(error)
        }
      )
    }
  }

  private filterSensitiveHeaders(headers: any): Record<string, string> {
    const filtered: Record<string, string> = {}

    for (const [key, value] of Object.entries(headers || {})) {
      if (this.config.sensitiveHeaders.includes(key.toLowerCase())) {
        filtered[key] = '***REDACTED***'
      } else {
        filtered[key] = String(value)
      }
    }

    return filtered
  }

  private calculateDuration(config: any): string {
    const startTime = config.metadata?.startTime
    if (startTime) {
      return \`\${Date.now() - startTime}ms\`
    }
    return 'unknown'
  }
}`,
        explanation: 'å¯¦ç¾å®Œæ•´çš„è«‹æ±‚å’ŒéŸ¿æ‡‰æ—¥èªŒæ””æˆªå™¨ï¼Œæ”¯æ´æ•æ„Ÿä¿¡æ¯éæ¿¾'
    }
]

const interceptorChainCode = `// æ””æˆªå™¨éˆçµ„åˆ
class InterceptorManager {
  private axiosInstance: typeof axios

  constructor(axiosInstance: typeof axios) {
    this.axiosInstance = axiosInstance
  }

  setupInterceptorChain() {
    // 1. æ—¥èªŒæ””æˆªå™¨ (æœ€å¤–å±¤)
    const loggingInterceptor = new LoggingInterceptor({
      logRequests: true,
      logResponses: true,
      logErrors: true,
      sensitiveHeaders: ['authorization', 'cookie']
    })
    loggingInterceptor.setup(this.axiosInstance)

    // 2. èªè­‰æ””æˆªå™¨
    const authInterceptor = new AuthInterceptor({
      getToken: () => localStorage.getItem('token'),
      refreshToken: async () => {
        // token åˆ·æ–°é‚è¼¯
        return 'new-token'
      },
      onAuthError: () => {
        // ç™»å‡ºè™•ç†
      }
    })
    authInterceptor.setupRequestInterceptor(this.axiosInstance)
    authInterceptor.setupResponseInterceptor(this.axiosInstance)

    // 3. é‡è©¦æ””æˆªå™¨
    const retryInterceptor = new RetryInterceptor({
      retries: 3,
      retryDelay: 1000,
      retryCondition: (error) => {
        return error.response?.status >= 500
      }
    })
    retryInterceptor.setup(this.axiosInstance)
  }
}`

const conditionalInterceptorCode = `// æ¢ä»¶æ””æˆªå™¨å¯¦ç¾
interface ConditionalInterceptorConfig {
  condition: (config: InternalAxiosRequestConfig) => boolean
  interceptor: RequestInterceptorFulfilled
}

class ConditionalInterceptor {
  static create(configs: ConditionalInterceptorConfig[]) {
    return (config: InternalAxiosRequestConfig) => {
      for (const { condition, interceptor } of configs) {
        if (condition(config)) {
          return interceptor(config)
        }
      }
      return config
    }
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const conditionalRequestInterceptor = ConditionalInterceptor.create([
  {
    // åªå° API è«‹æ±‚æ·»åŠ èªè­‰
    condition: (config) => config.url?.startsWith('/api/') ?? false,
    interceptor: (config) => {
      const token = getToken()
      if (token && config.headers) {
        config.headers.Authorization = \`Bearer \${token}\`
      }
      return config
    }
  },
  {
    // åªå°ä¸Šå‚³è«‹æ±‚è¨­å®šç‰¹æ®Š headers
    condition: (config) => config.url?.includes('/upload') ?? false,
    interceptor: (config) => {
      if (config.headers) {
        config.headers['Content-Type'] = 'multipart/form-data'
      }
      return config
    }
  }
])`

function runExample(code: string) {
    console.log('Running example:', code)
}

function completeSection() {
    emit('complete')
}
</script>

<style scoped>
.interceptors-typing {
    max-width: 100%;
    margin: 0 auto;
    padding: 0;
}

.section-intro {
    margin-bottom: 2rem;
}

.section-intro h2 {
    font-size: 1.75rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.intro-text {
    font-size: 1.1rem;
    line-height: 1.6;
    color: #4a5568;
}

.interceptor-concepts {
    margin-bottom: 3rem;
}

.interceptor-concepts h3 {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.concepts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.concept-card {
    padding: 1.5rem;
    background: #f7fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.concept-card h4 {
    color: #2d3748;
    margin-bottom: 0.75rem;
}

.concept-card p {
    color: #4a5568;
    margin: 0;
    line-height: 1.5;
}

.request-interceptors,
.response-interceptors {
    margin-bottom: 3rem;
}

.request-interceptors h3,
.response-interceptors h3 {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.practical-examples {
    margin-bottom: 3rem;
}

.practical-examples h3 {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.example-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tab-button {
    padding: 0.5rem 1rem;
    border: 1px solid #cbd5e0;
    border-radius: 4px 4px 0 0;
    background: #f7fafc;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-button.active {
    background: white;
    color: #2d3748;
    border-bottom-color: white;
}

.example-content {
    border: 1px solid #cbd5e0;
    border-radius: 0 8px 8px 8px;
    background: white;
    padding: 1.5rem;
}

.advanced-patterns {
    margin-bottom: 3rem;
}

.advanced-patterns h3 {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.pattern-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
}

.pattern-card h4 {
    color: #2d3748;
    margin-bottom: 1rem;
}

.best-practices {
    margin-bottom: 3rem;
}

.best-practices h3 {
    font-size: 1.5rem;
    color: #2d3748;
    margin-bottom: 1rem;
}

.practice-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.practice-item {
    padding: 1.5rem;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.practice-item h4 {
    margin-bottom: 1rem;
    color: #2d3748;
}

.practice-item ul {
    margin: 0;
    padding-left: 1.5rem;
}

.practice-item li {
    margin-bottom: 0.5rem;
    color: #4a5568;
}

.navigation-footer {
    text-align: center;
    padding-top: 2rem;
    border-top: 1px solid #e2e8f0;
}

.btn-complete {
    padding: 0.75rem 2rem;
    background: #48bb78;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-complete:hover {
    background: #38a169;
    transform: translateY(-1px);
}

@media (max-width: 768px) {

    .concepts-grid,
    .pattern-grid,
    .practice-list {
        grid-template-columns: 1fr;
    }
}
</style>
